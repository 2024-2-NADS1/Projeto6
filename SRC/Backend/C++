#include <WiFi.h>
#include <WebServer.h>

// definir senha e nome do wifi que o ESP32 vai se conectar.
const char* ssid = "Nome do Wifi Super Moderno"; 
const char* password = "Senha de wifi super segura"; 

// pinos e valores necessários
int Sensor = 33;
int rele = 32;
int valor = 0;
int segundos = 0;

WebServer server(80); // cria um servidor na porta 80

// procedimento para checar a umidade da terra e ativar bomba ou não se necessário
void checar(int Sensor, int rele) {
    int valor = analogRead(Sensor);
    Serial.println("valor Sensor");
    Serial.println(valor);
    // se estiver menor a umidez do solo que tal quantia defult:1500
    if (valor < 3500) {
        // se a terra estiver seca
        digitalWrite(rele, LOW);
        Serial.println("Bomba de Água Ligada!");
    } else {
        // se ela não estiver seca
        digitalWrite(rele, HIGH);
        Serial.println("Bomba de Água Desligada!");
    }
}

//função que devolve uma string escrita com a situação atual do solo do sensor.
String Solo(int Sensor) {
    int valor = analogRead(Sensor);
    String resultado;
    if (valor < 600) {
        resultado = "Solo Seco!!!";
    } 
    else if (valor >= 600 && valor < 1200) {
        resultado = "Solo Ressecado!";
    } 
    else if (valor >= 1200 && valor < 3200) {
        resultado = "Solo Umido!";
    } 
    else if (valor >= 3200) {
        resultado = "Solo Molhado!";
    } 
    else if (valor > 3200 && valor < 4100) {
        resultado = "Solo Encharcado!";
    }
    return resultado;
}

void setup() {
    pinMode(Sensor, INPUT);
    pinMode(rele, OUTPUT);
    Serial.begin(115200);
    digitalWrite(rele, HIGH);
    
    // Conectar ao Wi-Fi
    WiFi.begin(ssid, password);
    Serial.print("Conectando-se ao WiFi...");
    while (WiFi.status() != WL_CONNECTED) {
        delay(1000);
        Serial.print(".");
    }
    Serial.println("\nConectado ao WiFi!");
    Serial.print("Endereço IP: ");
    Serial.println(WiFi.localIP());

    // Configurações do servidor
    server.on("/umidade", []() {
        valor = analogRead(Sensor); // Atualiza o valor do sensor
        String umidade = String(valor);
        server.sendHeader("Access-Control-Allow-Origin", "*");
        server.send(200, "text/plain", umidade);
    });

    server.on("/Solo", []() {
        String resultado = Solo(Sensor); // Chama a função Solo
        server.sendHeader("Access-Control-Allow-Origin", "*");
        server.send(200, "text/plain", resultado);
    });

    // Nova rota para obter todos os dados
    server.on("/dados", []() {
        valor = analogRead(Sensor); // Atualiza o valor do sensor
        String umidade = String(valor);
        String solo = Solo(Sensor);
        String resultado = "{\"umidade\":" + umidade + ", \"solo\":\"" + solo + "\", \"segundos\":" + String(segundos) + "}";
        
        server.sendHeader("Access-Control-Allow-Origin", "*");
        server.send(200, "application/json", resultado);
    });

    // Inicia o servidor
    server.begin();
}

void loop() {
    server.handleClient(); // Mantém}
    segundos++;
    delay(1000);
}
